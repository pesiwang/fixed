
<include file="Public/head" />
<div class="page-content">
	<div class="row">
		<div class="col-xs-12">
			<!-- PAGE CONTENT BEGINS -->
			<div class="page-header">
				<h3 class="header smaller lighter black">
					<a href="{:U('Admin/Orderfixed/item')}">所有类目</a>-> <a
						href="{:U('Admin/Orderfixed/listbrand',array(" nav1_id" =>
						I('nav1_id'),"nav1"=>I('nav1')))}">{:I('nav1')}</a>-> <a
						href="{:U('Admin/Orderfixed/editbrand',array(" nav1_id" =>
						I('nav1_id'),"nav1"=>I('nav1'),"nav2"=>I('nav2'),"nav2_id" =>
						I('nav2_id')))}">{:I('nav2')}</a>-> {:I('nav3')}
				</h3>
			</div>
			<!-- /.page-header -->
			<!-- PAGE CONTENT BEGINS -->
			<div class="page-header">
				<div class="col-md-offset-3 col-md-9 col-md-pull-3">
					<button class="btn-sm btn-info" onclick="show_detail()">
						<i class="icon-ok bigger-110"></i> 添加/修改故障类型
					</button>
				</div>
			</div>
			<!-- /.page-header -->
			<div class="table-responsive">
				<table id="sample-table-2"
					class="table table-striped table-bordered table-hover ">
					<thead>
						<tr>
							<th>序号</th>
							<th>故障名称</th>
							<th>详细故障</th>
							<th><i class="icon-time bigger-110 hidden-480"></i> 操作</th>
						</tr>
					</thead>

					<tbody>
						<volist name='list' id='v'>
						<tr>
							<td>{$i}</td>
							<td>{$v.prbm}</td>
							<td>{$v.detail}</td>
							<td><a href='###' id='type-edit'
								onclick="type_edit('{$v['prbm']}')" class="green">详细故障</a></td>
						</tr>

						</volist>
					</tbody>
				</table>
			</div>
			<!-- 			故障原因细节 -->
			<div id="my-modal2" class="modal fade" tabindex="-1"
				aria-hidden="true" style="display: none;">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"
								aria-hidden="true">×</button>
							<h3 class="smaller lighter blue no-margin">修改手机维修费用</h3>
						</div>
						<div class="modal-body">
							<label class="col-sm-3 control-label no-padding-right">型号:</label>
							<input type="text" name="model" class="col-xs-5 col-sm-5" value="{:I('nav3_id')}" style="display: none">
							<input type="text" name="model_name" class="col-xs-5 col-sm-5" value="{:I('nav3')}" style="display: none">
							<div class="col-sm-12">
								<table id="sample-table-2"
									class="table table-striped table-bordered table-hover ">
									<thead>
										<tr>
											<th>序号</th>
											<th>详细故障</th>
											<th>解决方案</th>
											<th>费用</th>
										</tr>
									</thead>
									<tbody id="solution">
									</tbody>
								</table>
							</div>
						</div>
						<div class="modal-footer">
							<button class="btn btn-sm btn-danger pull-right" onclick="submitFee();">
								<i class="ace-icon fa fa-times"></i> 提交
							</button>
						</div>
					</div>
					<!-- /.modal-content -->
				</div>
			</div>
			<!-- /.modal-dialog -->
			<!-- 			end故障原因细节 -->

			<!-- 						故障原因 -->
			<div id="my-modal" class="modal fade" tabindex="-1"
				aria-hidden="true" style="display: none;">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"
								aria-hidden="true">×</button>
							<h3 class="smaller lighter blue no-margin">添加该型号手机支持的维修范围</h3>
						</div>
						<div class="modal-body">
							<label class="col-sm-3 control-label no-padding-right">大概问题:</label>
							<input type="text" style="display: none" name="data_prbm[parent]"
								class="col-xs-5 col-sm-5" value="{:I('nav3_id')}"
								placeholder="iphone 6s Plus"> <input type="text"
								style="display: none" name="data_prbm[id]"
								class="col-xs-5 col-sm-5" value="" placeholder="iphone 6s Plus">
							<div class="col-sm-8">
								<select multiple="multiple" size="10" name="data_prbm[prbm]">
									<option value="屏幕问题"<if
											condition="in_array('屏幕问题',$arr)">selected="selected"</if> 
										>屏幕问题
									</option>
									<option value="按键问题"<if
											condition="in_array('按键问题',$arr)">selected="selected"</if>
										>按键问题
									</option>
									<option value="扬声器"<if
											condition="in_array('扬声器',$arr)">selected="selected"</if>
										>扬声器
									</option>
									<option value="边框外壳"<if
											condition="in_array('边框外壳',$arr)">selected="selected"</if>
										>边框外壳
									</option>
									<option value="摄像头"<if
											condition="in_array('摄像头',$arr)">selected="selected"</if>
										>摄像头
									</option>
									<option value="电池"<if
											condition="in_array('电池',$arr)">selected="selected"</if>
										>电池
									</option>
									<option value="内存升级"<if
											condition="in_array('内存升级',$arr)">selected="selected"</if>
										>内存升级
									</option>
								</select>
								<script>
													    var demo1 = $('select[name="data_prbm[prbm]"]').bootstrapDualListbox();
													  </script>
							</div>
						</div>
						<div class="modal-footer">
							<button class="btn btn-sm btn-danger pull-right"
								id="type-submit-prbm">
								<i class="ace-icon fa fa-times"></i> 提交
							</button>
						</div>
					</div>
					<!-- /.modal-content -->
				</div>
			</div>
			<!-- /.modal-dialog -->
			<!-- 					end	故障原因 -->

		</div>
	</div>
</div>
</div>
</div>
</div>
<script>
	function show_detail(){
		$('#my-modal').modal('show')
	}
	function type_edit(id){
		var dom='';
		window.parent_prbm=id;
		$.ajax({
			url:'{:U("Admin/Orderfixed/echoprbmdetail_ajax")}',
			data:'prbm='+id+'&parent='+{:I('nav3_id')},
			type:'post',
			success:function(msg){
				if(msg.code==0){
					build4feeDom(msg.list);
					addClickAction();
					$('#my-modal2').modal('show')
				}else{
					alert(msg.msg);
				}
			}
		});
	}
	</script>
<script>
	$(function(){
		$('#type-submit-prbm').bind('click',function(){
			var prbm_parent=$('[name="data_prbm[parent]"]').val();
			var prbm_prbm=$('[name="data_prbm[prbm]"]').val();
			var prbm_id=$('[name="data_type[id]"]').val();
			$.ajax({
				url:'{:U("Admin/Orderfixed/editprbm_ajax")}',
				type:'post',
				dataType:'json',
				data:{
					'data':{
					'parent':prbm_parent,
					'prbm':prbm_prbm
					}
				},
				success:function(msg){
					alert(msg.msg);
					if(msg.code==0)location.reload();
				}
			});
		});
		$('#type-submit-prbm-detail').bind('click',function(){
			var prbm_detail=$('[name="data_prbm_detail[detail]"]').val();
			var prbm_prbm=window.parent_prbm;
			$.ajax({
				url:'{:U('Admin/Orderfixed/editprbmdetail_ajax')}',
				type:'post',
				data:{
					'data':prbm_detail,
					'prbm':prbm_prbm,
					'parent':{:I('nav3_id')}
				},
				success:function(msg){
					alert(msg.msg);
					if(msg.code==0)location.reload();
				}
			});
		})
	});
	
	function build4feeDom(data)
	{
		var dom = '';
		$(data).each( function (k, v){
			if (v.fee == 0) {
			dom += '<tr><td><input type="checkbox" class="checkbox" val="'+k
			+ '"></td><td>'+ v.detail
			+ '</td><td>'+ v.solution
			+ '</td><td><input type="text" disabled="disabled" name="fee'+k+'" class="fee'+k+'"/></td></tr>';
			}else{
				dom += '<tr><td><input type="checkbox" checked="checked" class="checkbox" val="'+k
				+ '"></td><td>'+ v.detail
				+ '</td><td>'+ v.solution
				+ '</td><td><input type="text" name="fee'+k+'" value="'+v.fee+'" class="fee'+k+'"/></td></tr>';
			}
		});
		
		$('#solution').html(dom);
	}
	
	function addClickAction()
	{
		$('.checkbox').click( function () {
			var val = $(this).attr('val');
			if($(this).is(':checked')){
				$('.fee'+val).removeAttr("disabled");
			}else{
				$('.fee'+val).attr("disabled","disabled");
			}
			
		});
	}
	
	function submitFee()
	{
		var data = new Object();
		data['list'] = new Object();
		data['where'] = new Object();
		var model = $('[name=model]').val();
		var model_name = $('[name=model_name]').val();
		$('.checkbox').each( function (k, v) {
			if($(this).is(':checked')){
				var tmp = new Object();
				var val = $(this).attr('val');
				tmp['detail'] = $(this).parent().next().html();
				tmp['solution'] = $(this).parent().next().next().html();
				tmp['fee'] = $('.fee'+val).val();
				data['list'][k] = tmp;
			}
			data['where']['model'] = model;
			data['where']['model_name'] = model_name;
			data['where']['detail_parent'] = window.parent_prbm; 
		});
		
		data = JSON.stringify(data);
		$.ajax({
			url:'{:U("Admin/Orderfixed/edit_soulution")}',
			type:'post',
			dataType:'json',
			data : eval("(" + data + ")"),
			success:function(msg){
				alert(msg.msg);
				if(msg.code==0)location.reload();
			}
		});
		
	}
	</script>
<include file="Public/foot" />